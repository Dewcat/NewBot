# SimpleBot 技能效果系统详细帮助文档

## 目录
- [系统概述](#系统概述)
- [技能结构详解](#技能结构详解)
- [主要效果系统](#主要效果系统)
- [次要效果系统](#次要效果系统)
- [数值计算系统](#数值计算系统)
- [目标解析系统](#目标解析系统)
- [完整示例](#完整示例)
- [常见问题与最佳实践](#常见问题与最佳实践)

---

## 系统概述

SimpleBot的技能效果系统基于**主次效果分离**的设计理念，通过JSON格式提供高度灵活的技能配置能力。系统支持复杂的目标选择、百分比计算和多重效果组合。

### 核心设计理念
- **主要效果**: 由`skill_category`字段决定，影响目标选择和核心功能
- **次要效果**: 在`effects` JSON字段中定义，支持复杂的组合效果  
- **目标分离**: 每个效果可独立指定作用目标
- **计算灵活**: 支持固定数值和百分比动态计算

---

## 技能结构详解

### 数据库字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `name` | TEXT | ✅ | 技能名称，用于显示 |
| `skill_category` | TEXT | ✅ | 技能主分类，决定主要效果 |
| `description` | TEXT | ❌ | 技能描述信息 |
| `damage_formula` | TEXT | ❌ | 主效果数值计算公式 |
| `damage_type` | TEXT | ❌ | 伤害类型：'physical' 或 'magical' |
| `effects` | TEXT | ❌ | 次要效果的JSON字符串 |
| `target_races` | TEXT | ❌ | 特攻种族列表，JSON格式 |
| `cooldown` | INTEGER | ❌ | 冷却时间（次行动） |

### 完整技能示例
```json
{
  "name": "烈焰冲击",
  "skill_category": "damage",
  "description": "造成火焰伤害并燃烧敌人，同时为自己增加攻击力",
  "damage_formula": "15+2d6",
  "damage_type": "magical",
  "effects": {
    "status": [
      {
        "effect": "burn",
        "turns": 3,
        "value": 5,
        "target": "skill_target"
      },
      {
        "effect": "strong", 
        "turns": 2,
        "value": 1,
        "target": "self"
      }
    ],
    "heal": {
      "target": "self",
      "percentage": 10
    }
  },
  "target_races": ["不死族", "冰系元素"],
  "cooldown": 2
}
```

---

## 主要效果系统

主要效果由`skill_category`字段决定，控制技能的核心功能和目标选择逻辑。

### 技能分类详解

#### 🔥 单体伤害类技能
| 分类 | 代码 | 目标选择 | 主要功能 |
|------|------|---------|---------|
| 伤害技能 | `damage` | 敌方单体 | 对选中敌人造成伤害 |

**执行流程**：
1. 用户选择敌方目标
2. 计算基础伤害（基于`damage_formula`）
3. 应用攻防修正和抗性计算
4. 应用状态效果修正（攻击者增益、目标减益）
5. 扣除目标生命值
6. 处理次要效果（传入最终伤害值）

**伤害计算公式**：
```
最终伤害 = (基础伤害 + 攻击力 - 防御力) × (1 - 抗性) × 状态修正
```

#### 💚 单体治疗类技能  
| 分类 | 代码 | 目标选择 | 主要功能 |
|------|------|---------|---------|
| 治疗技能 | `healing` | 友方单体 | 恢复选中友方的生命值 |

**执行流程**：
1. 用户选择友方目标
2. 计算治疗量（基于`damage_formula`，不受攻防影响）
3. 恢复目标生命值（不超过最大值）
4. 处理次要效果（传入实际治疗量）

#### ✨ 单体增益类技能
| 分类 | 代码 | 目标选择 | 主要功能 |
|------|------|---------|---------|
| 增益技能 | `buff` | 友方单体 | 为选中友方添加增益状态 |

**特点**：
- 不造成伤害，不进行治疗
- 主要通过次要效果系统施加状态
- 传给次要效果的主效果值为0

#### 💀 单体减益类技能
| 分类 | 代码 | 目标选择 | 主要功能 |
|------|------|---------|---------|
| 减益技能 | `debuff` | 敌方单体 | 为选中敌方添加减益状态 |

**特点**：
- 不造成伤害，不进行治疗
- 主要通过次要效果系统施加状态
- 传给次要效果的主效果值为0

#### 🧘 自我强化类技能
| 分类 | 代码 | 目标选择 | 主要功能 |
|------|------|---------|---------|
| 自我技能 | `self` | 无需选择 | 只对施法者产生效果 |

**特点**：
- 跳过目标选择界面
- 固定以施法者为目标
- 通过次要效果系统实现具体功能

#### 🌀 AOE范围类技能

| 分类 | 代码 | 目标选择 | 主要功能 |
|------|------|---------|---------|
| AOE伤害 | `aoe_damage` | 无需选择 | 对所有敌方造成伤害 |
| AOE治疗 | `aoe_healing` | 无需选择 | 治疗所有友方 |
| AOE增益 | `aoe_buff` | 无需选择 | 为所有友方添加增益 |
| AOE减益 | `aoe_debuff` | 无需选择 | 为所有敌方添加减益 |

**AOE技能特点**：
- 自动选择所有符合条件的目标
- 跳过目标选择界面，直接执行
- 传给次要效果的是总效果值（如总伤害、总治疗）

---

## 次要效果系统

次要效果在`effects` JSON字段中定义，支持多种效果类型的灵活组合。

### Effects JSON结构

```json
{
  "status": [状态效果数组],
  "damage": {伤害效果配置},
  "heal": {治疗效果配置}
}
```

### 状态效果 (status)

状态效果用于添加增益(buff)或减益(debuff)状态。

#### 基本格式
```json
{
  "status": [
    {
      "effect": "状态名称",
      "turns": 持续回合数,
      "value": 效果强度/层数,
      "target": "目标类型"
    }
  ]
}
```

#### 支持的状态效果

**🌟 增益状态(Buff)**
| 状态名称 | 代码 | 效果描述 | 触发时机 |
|---------|------|---------|---------|
| 强壮 | `strong` | 攻击伤害 +(层数×10%) | 造成伤害时 |
| 🔰守护 | `guard` | 受到伤害 -(层数×10%) | 受到攻击时 |
| 呼吸法 | `breath` | 暴击率+强度×1%，暴击倍率120% | 造成伤害时 |
| 护盾 | `shield` | 优先抵消护盾值，耗尽后移除 | 受到攻击时 |
| 加速 | `speed` | 增加行动次数和冷却缩减 | 回合开始时 |

**💀 减益状态(Debuff)**
| 状态名称 | 代码 | 效果描述 | 触发时机 |
|---------|------|---------|---------|
| 烧伤 | `burn` | 每回合结束扣强度×1点血 | 回合结束 |
| 中毒 | `poison` | 每回合结束扣强度×1%最大生命值 | 回合结束 |
| 破裂 | `crack` | 受击时扣强度×1点血并减1层 | 受到攻击时 |
| 流血 | `bleed` | 行动后扣强度×1点血并减1层 | 行动后 |
| 虚弱 | `weak` | 攻击伤害 -(层数×10%) | 造成伤害时 |
| 易伤 | `vulnerable` | 受到伤害 +(层数×10%) | 受到攻击时 |

#### 状态效果示例

**单个状态效果**：
```json
{
  "status": [
    {
      "effect": "strong",
      "turns": 3,
      "value": 2,
      "target": "self"
    }
  ]
}
```

**多个状态效果**：
```json
{
  "status": [
    {
      "effect": "strong",
      "turns": 3,
      "value": 2,
      "target": "self"
    },
    {
      "effect": "burn",
      "turns": 5,
      "value": 8,
      "target": "skill_target"
    }
  ]
}
```

### 伤害效果 (damage)

用于造成额外伤害，独立于主效果的伤害计算。

#### 基本格式
```json
{
  "damage": {
    "target": "目标类型",
    "amount": 固定伤害值,        // 与percentage互斥
    "percentage": 百分比值       // 基于主效果的百分比
  }
}
```

#### 计算规则
- **固定数值**: 直接使用`amount`指定的数值
- **百分比计算**: `percentage` × 主效果数值 ÷ 100
- **优先级**: `amount`优先于`percentage`

#### 示例

**固定伤害**：
```json
{
  "damage": {
    "target": "skill_target",
    "amount": 25
  }
}
```

**百分比伤害**：
```json
{
  "damage": {
    "target": "all_enemies",
    "percentage": 30
  }
}
```
*如果主效果造成100点伤害，则额外对所有敌人造成30点伤害*

### 治疗效果 (heal)

用于恢复目标的生命值，独立于主效果的治疗计算。

#### 基本格式
```json
{
  "heal": {
    "target": "目标类型",
    "amount": 固定治疗值,        // 与percentage互斥
    "percentage": 百分比值       // 基于主效果的百分比
  }
}
```

#### 计算规则
- 治疗不会超过目标的最大生命值
- 百分比基于主效果数值计算（伤害技能的话就是伤害值）
- 支持负数治疗（实际造成伤害）

#### 示例

**固定治疗**：
```json
{
  "heal": {
    "target": "self",
    "amount": 20
  }
}
```

**百分比治疗**：
```json
{
  "heal": {
    "target": "all_allies",
    "percentage": 15
  }
}
```
*如果主效果造成200点伤害，则为所有友方恢复30点生命值*

---

## 数值计算系统

### 主效果数值计算

主效果数值通过`damage_formula`字段计算，支持多种格式：

#### 骰子公式格式
```
基础数值 + 骰子数量d骰子面数 + 额外修正
```

**示例**：
- `"10"` → 固定10点
- `"1d6"` → 1-6点随机
- `"15+2d6"` → 15+(2-12)点，总计17-27点
- `"20+3d8-5"` → 20+(3-24)-5，总计18-39点

#### 属性修正
伤害技能会自动加入攻击者的攻击属性和目标的防御属性：
```
物理伤害 = 公式结果 + 攻击力 - 防御力
魔法伤害 = 公式结果 + 魔法攻击 - 魔法防御
```

#### 抗性计算
最终伤害会受到目标抗性影响：
```
最终伤害 = 伤害 × (1 - 对应抗性)
```

### 次要效果数值计算

次要效果支持两种计算方式：

#### 1. 固定数值 (amount)
```json
{
  "damage": {
    "target": "skill_target",
    "amount": 50
  }
}
```
直接使用指定的数值，不受主效果影响。

#### 2. 百分比计算 (percentage)
```json
{
  "heal": {
    "target": "self",
    "percentage": 25
  }
}
```

**计算公式**：
```
次要效果数值 = 主效果实际数值 × percentage ÷ 100
```

**示例计算**：
- 主效果造成120点伤害
- 次要治疗设置`percentage: 25`
- 实际治疗量：120 × 25 ÷ 100 = 30点

---

## 目标解析系统

每个效果都可以通过`target`字段独立指定作用目标，实现灵活的目标控制。

### 支持的目标类型

| 目标类型 | 代码 | 说明 | 使用场景 |
|---------|------|------|---------|
| 施法者 | `self` | 技能使用者本人 | 自我增益、反伤治疗 |
| 技能目标 | `skill_target` | 技能选择的目标 | 主要效果的延续 |
| 施法者 | `attacker` | 技能使用者（同self） | 兼容性别名 |
| 所有友方 | `all_allies` | 所有友方角色 | 团队增益、群体治疗 |
| 所有敌方 | `all_enemies` | 所有敌方角色 | 群体减益、范围伤害 |
| 友方角色 | `friendly` | 所有友方角色（同all_allies） | 兼容性别名 |
| 敌方角色 | `enemy` | 所有敌方角色（同all_enemies） | 兼容性别名 |

### 目标选择逻辑

#### 动态目标解析
系统会根据施法者的类型动态确定友方和敌方：
- **友方角色使用技能**：friendly=友方角色，enemy=敌方角色
- **敌方角色使用技能**：friendly=敌方角色，enemy=友方角色

#### 战斗状态过滤
只有处于战斗状态(`in_battle=1`)的角色会被包含在群体目标中。

#### 目标验证
- 如果指定目标不存在或无效，效果会被跳过
- `skill_target`为空时会默认使用施法者(`self`)

---

## 完整示例

### 示例1：复合攻击技能

**技能概念**：对敌人造成火焰伤害，同时燃烧目标、强化自己，并为队友恢复少量生命值。

```json
{
  "name": "烈焰强袭",
  "skill_category": "damage",
  "description": "强力的火焰攻击，伤害敌人的同时强化自身，并为队友提供治疗",
  "damage_formula": "25+3d8",
  "damage_type": "magical",
  "effects": {
    "status": [
      {
        "effect": "burn",
        "turns": 4,
        "value": 6,
        "target": "skill_target"
      },
      {
        "effect": "strong",
        "turns": 3,
        "value": 2,
        "target": "self"
      }
    ],
    "heal": {
      "target": "all_allies",
      "percentage": 15
    }
  },
  "target_races": ["不死族", "冰系"],
  "cooldown": 3
}
```

**执行流程分析**：
1. **主效果**：对选中敌人造成25+3d8点魔法伤害（假设结果为40点）
2. **次要效果**：
   - 给目标添加烧伤状态（4回合，每回合6点伤害）
   - 给自己添加强壮状态（3回合，攻击力+20%）
   - 为所有友方恢复生命值：40 × 15% = 6点

### 示例2：群体增益技能

**技能概念**：为所有队友提供攻击和防御加成，同时为自己提供护盾保护。

```json
{
  "name": "战斗号令",
  "skill_category": "aoe_buff",
  "description": "激励所有队友，提升攻击和防御能力",
  "effects": {
    "status": [
      {
        "effect": "strong",
        "turns": 5,
        "value": 2,
        "target": "all_allies"
      },
      {
        "effect": "guard",
        "turns": 5,
        "value": 1,
        "target": "all_allies"
      },
      {
        "effect": "shield",
        "turns": 3,
        "value": 50,
        "target": "self"
      }
    ]
  },
  "cooldown": 5
}
```

**执行流程分析**：
1. **主效果**：AOE增益，无直接数值效果
2. **次要效果**：
   - 为所有友方添加强壮状态（5回合，攻击力+20%）
   - 为所有友方添加🔰守护状态（5回合，受伤-10%）
   - 为自己添加护盾（3回合，50点护盾值）

### 示例3：牺牲型技能

**技能概念**：消耗自己的生命值为队友提供强大的治疗和增益效果。

```json
{
  "name": "生命献祭",
  "skill_category": "aoe_healing",
  "description": "牺牲自己的生命力量，为队友提供强大的支援",
  "damage_formula": "30+2d12",
  "effects": {
    "damage": {
      "target": "self",
      "percentage": 50
    },
    "status": [
      {
        "effect": "strong",
        "turns": 4,
        "value": 3,
        "target": "all_allies"
      },
      {
        "effect": "guard",
        "turns": 4,
        "value": 2,
        "target": "all_allies"
      }
    ]
  },
  "cooldown": 6
}
```

**执行流程分析**：
1. **主效果**：为所有友方恢复30+2d12点生命值（假设结果为45点）
2. **次要效果**：
   - 对自己造成伤害：45 × 50% = 22点（牺牲代价）
   - 为所有友方添加强壮状态（4回合，攻击力+30%）
   - 为所有友方添加🔰守护状态（4回合，受伤-20%）

---

## 常见问题与最佳实践

### 常见问题解答

#### Q: percentage和amount可以同时使用吗？
A: 不可以。系统会优先使用`amount`，忽略`percentage`。建议只使用其中一个。

#### Q: 为什么我的AOE技能没有跳过目标选择？
A: 检查`skill_category`是否使用了正确的AOE分类（`aoe_damage`、`aoe_healing`、`aoe_buff`、`aoe_debuff`），而不是旧的`aoe`。

#### Q: 状态效果的target设置为skill_target，但AOE技能没有目标怎么办？
A: AOE技能的次要效果应该使用`all_allies`、`all_enemies`或`self`作为目标，避免使用`skill_target`。

#### Q: 百分比计算的基准是什么？
A: 百分比始终基于**当次技能的主效果实际数值**。伤害技能就是实际造成的伤害，治疗技能就是实际治疗量。

#### Q: 如何创建不造成伤害但有次要效果的攻击？
A: 使用`buff`或`debuff`作为`skill_category`，不设置`damage_formula`，所有效果通过`effects`实现。

### 最佳实践

#### 1. 技能设计原则
- **单一职责**：主效果应该明确技能的核心功能
- **合理搭配**：次要效果应该与主效果形成合理的组合
- **平衡性**：避免单个技能过于强大，保持游戏平衡

#### 2. 数值设置建议
- **伤害技能**：基础伤害15-30，次要效果percentage控制在10-30%
- **治疗技能**：治疗量略低于同等级伤害技能
- **状态持续时间**：一般不超过5回合，避免效果过久
- **冷却时间**：强力技能设置2-5回合冷却

#### 3. 目标选择策略
- **单体技能**：主效果用`skill_target`，次要效果可用`self`
- **AOE技能**：避免在次要效果中使用`skill_target`
- **支援技能**：多使用`all_allies`和`self`组合
- **控制技能**：合理使用`all_enemies`和`skill_target`

#### 4. JSON格式规范
- 使用标准的JSON格式，注意大小写
- 效果名称使用小写英文（如`strong`，不是`Strong`）
- 数值类型使用整数，避免小数
- 适当使用注释（在实际使用时需要移除）

#### 5. 测试建议
- **功能测试**：确保技能的每个效果都能正常触发
- **数值测试**：验证百分比计算的准确性
- **边界测试**：测试极端情况（如0伤害、满血治疗等）
- **组合测试**：测试多个状态效果的交互

---

## 附录：快速参考

### 技能分类速查表
```
damage      → 单体伤害
healing     → 单体治疗  
buff        → 单体增益
debuff      → 单体减益
self        → 自我效果
aoe_damage  → 群体伤害
aoe_healing → 群体治疗
aoe_buff    → 群体增益
aoe_debuff  → 群体减益
```

### 目标类型速查表
```
self         → 施法者本人
skill_target → 技能选择的目标
all_allies   → 所有友方角色
all_enemies  → 所有敌方角色
```

### 状态效果速查表
```
增益：strong, guard, breath, shield, speed
减益：burn, poison, crack, bleed, weak, vulnerable
```

### 计算公式速查表
```
主效果伤害 = (公式结果 + 攻击力 - 防御力) × (1-抗性) × 状态修正
次要百分比 = 主效果实际数值 × percentage ÷ 100
状态层数叠加 = min(当前层数 + 新增层数, 99)
```

---

*文档版本: v2.0*  
*最后更新: 2024年12月*  
*适用于: SimpleBot v2.0+*
