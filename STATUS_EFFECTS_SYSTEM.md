# 状态效果系统实现文档

## 概述

本次更新实现了完整的状态效果系统，为 SimpleBot 添加了技能分类、增益减益效果和回合管理功能。

## 主要功能

### 1. 技能分类系统

技能现在分为四种类型：
- **伤害 (damage)**: 直接造成伤害的技能
- **治疗 (healing)**: 恢复生命值的技能  
- **增益 (buff)**: 施加有利状态效果的技能
- **减益 (debuff)**: 施加不利状态效果的技能

如果技能的 `skill_category` 字段为空，默认为伤害技能。

### 2. 状态效果系统

#### 增益效果 (Buff)
1. **强壮 (strong)**
   - 效果：攻击技能最终伤害 + (层数 × 10%)
   - 应用时机：造成伤害时

2. **呼吸法 (breathing)**
   - 效果：暴击率 + 强度 × 1%，暴击伤害为 120%
   - 应用时机：攻击时判定暴击

3. **守护 (guard)**
   - 效果：受到最终伤害 - (层数 × 10%)
   - 应用时机：受到伤害时

4. **护盾 (shield)**
   - 效果：受到最终伤害 - 护盾强度，护盾强度会减少对应数值
   - 特殊：护盾强度减到0以下时移除该状态，回合结束不减层数
   - 应用时机：受到伤害时

#### 减益效果 (Debuff)
1. **烧伤 (burn)**
   - 效果：每回合结束按强度 × 1点扣血
   - 应用时机：回合结束时

2. **中毒 (poison)**
   - 效果：每回合结束按强度 × 1%体力扣血
   - 应用时机：回合结束时

3. **破裂 (rupture)**
   - 效果：受击时按强度 × 1点扣血，并减少1层数
   - 特殊：该 debuff 回合结束不会减少层数
   - 应用时机：受到伤害时

4. **流血 (bleeding)**
   - 效果：行动后按强度 × 1点扣血，并减少1层数
   - 特殊：该 debuff 回合结束不会减少层数
   - 应用时机：行动后

5. **虚弱 (weak)**
   - 效果：攻击技能最终伤害 - (层数 × 10%)
   - 应用时机：造成伤害时

6. **易伤 (vulnerable)**
   - 效果：受到最终伤害 + (层数 × 10%)
   - 应用时机：受到伤害时

### 3. 状态效果叠加规则

- 当角色获得已有的状态效果时：
  - **强度**: 取当前强度与新强度的较高值
  - **层数**: 累加当前层数与新层数
- 每回合结束时，除了特殊说明的效果外，所有状态效果层数减1
- 破裂和流血：受击/行动时触发并减层数，回合结束不减层
- 护盾：受到伤害时消耗，回合结束不减层数，只有被完全消耗才移除
- 层数为0的状态效果会被自动移除

### 4. 回合管理系统

- 新增 `/end_turn` 命令来结束回合
- 回合结束时自动处理所有在战斗中角色的状态效果
- 显示详细的状态效果触发信息

### 5. 数据库结构更新

#### 新增表：character_status_effects
```sql
CREATE TABLE character_status_effects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    character_id INTEGER NOT NULL,
    effect_type TEXT NOT NULL,      -- buff 或 debuff
    effect_name TEXT NOT NULL,      -- 具体状态名称
    intensity INTEGER NOT NULL DEFAULT 1,  -- 强度
    duration INTEGER NOT NULL DEFAULT 1,   -- 层数/持续回合
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (character_id) REFERENCES characters (id) ON DELETE CASCADE
)
```

#### 技能表更新
- 新增 `skill_category` 字段，用于标识技能类型
- 更新现有技能的分类信息

## 新增技能

系统添加了以下状态效果技能作为示例：

| ID | 技能名称 | 类型 | 效果 |
|----|----------|------|------|
| 17 | 强壮 | damage | 造成伤害并给自己施加强壮效果 |
| 18 | 守护 | buff | 给自己施加守护效果 |
| 19 | 烧伤攻击 | damage | 造成伤害并给目标施加烧伤 |
| 20 | 中毒箭 | damage | 造成伤害并给目标施加中毒 |
| 21 | 虚弱诅咒 | debuff | 给目标施加虚弱效果 |
| 22 | 易伤标记 | debuff | 给目标施加易伤效果 |
| 23 | 呼吸法 | buff | 给自己施加呼吸法效果 |
| 24 | 护盾术 | buff | 给自己施加护盾效果 |

## 更新的模块

### 新增模块
1. `src/character/status_effects.py` - 状态效果管理核心模块
2. `src/game/turn_manager.py` - 回合管理系统

### 修改的模块
1. `src/skill/skill_effects.py` - 重构技能执行逻辑，支持四种技能类型
2. `src/character/status_formatter.py` - 添加状态效果显示
3. `src/database/db_migration.py` - 添加状态效果系统迁移
4. `src/main.py` - 添加回合管理命令和帮助信息更新

## 使用说明

### 基本使用流程
1. 创建角色：`/cc 角色名`
2. 添加状态效果技能：`/sm 角色名`
3. 加入战斗：`/join 角色名`
4. 使用技能：`/attack` 或 `/enemy_attack`
5. 结束回合：`/end_turn`
6. 查看状态：`/show 角色名`

### 状态效果在角色面板中的显示
角色状态面板现在会显示：
- 增益效果：强度和层数信息
- 减益效果：强度和层数信息  
- 护盾效果：当前护盾值

### 战斗流程中的状态效果
1. **攻击时**: 
   - 计算攻击者的强壮/虚弱修正
   - 判定呼吸法暴击
   - 处理攻击者的行动后效果（流血）

2. **受击时**:
   - 计算目标的守护/易伤修正
   - 处理护盾抵消
   - 触发破裂效果

3. **回合结束时**:
   - 处理烧伤/中毒伤害
   - 减少状态效果层数
   - 移除层数为0的效果

## 技术实现细节

### 状态效果计算顺序
1. 攻击者状态修正（强壮、虚弱、呼吸法）
2. 目标受击状态修正（守护、易伤、护盾、破裂）
3. 伤害应用
4. 技能状态效果施加
5. 行动后效果处理（流血）

### 错误处理
- 状态效果数据库操作失败时会记录日志并返回默认值
- JSON 解析失败时会使用空字典作为默认值
- 角色不存在时会跳过状态效果处理

### 性能考虑
- 状态效果查询使用索引优化
- 批量处理回合结束效果
- 合理的消息长度限制防止刷屏

## 测试建议

请参考 `status_effects_test_guide.py` 中的详细测试步骤来验证系统功能。

## 未来扩展

系统设计为可扩展的，可以轻松添加新的状态效果类型：
1. 在 `status_effects.py` 中添加新的效果处理逻辑
2. 在数据库中添加相应的技能记录
3. 更新显示图标和描述文本

---

**实现日期**: 2025年7月27日  
**版本**: v2.0.0 - 状态效果系统
