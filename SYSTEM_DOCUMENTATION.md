# Dewbot 系统总览文档

## 1. 系统概述

Dewbot 是一个基于 Telegram 平台的模块化角色扮演（RPG）机器人。它围绕一个复杂的回合制战斗系统构建，该系统支持详细的角色定制、动态的技能效果和深入的情感养成机制。本文档旨在全面概述其核心系统，包括角色管理、战斗逻辑、技能效果、回合流程和数据库结构。

---

## 2. 角色系统

角色系统是管理游戏中所有可操作实体的核心，包括玩家角色和敌人。它支持丰富的角色定制，包括和独特的“人格”系统、种族属性和动态的状态管理。

### 2.1. 核心角色与人格系统

系统预设了五个“核心角色”：**珏、露、莹、笙、曦**。这些角色拥有独特的**人格（Persona）**系统，允许他们在不同的战斗形态之间切换。

*   **人格（Persona）**：每个人格代表角色的一套特定属性、技能和战斗风格。切换人格会改变角色的生命值、攻击力、防御力以及可用的技能组合。
*   **切换机制**：玩家可以通过 `/switch` 或 `/persona` 命令为核心角色切换人格，以适应不同的战斗需求。

### 2.2. 角色属性

每个角色都有一系列基础属性，定义了其在战斗中的能力：

*   **核心属性**：生命值（Health）、攻击力（Attack）、防御力（Defense）。
*   **战斗属性**：
    *   `in_battle`：标记角色是否在战斗中。
    *   `actions_per_turn`：每回合的行动次数。
    *   `current_actions`：当前剩余的行动次数。
*   **种族与抗性**：
    *   `race_tags`：角色的种族标签，用于触发特定的技能效果。
        *   **支持的种族**：human (人类), elf (精灵), dwarf (矮人), orc (兽人), dragon (龙), demon (恶魔), angel (天使), beast (野兽), undead (亡灵), machine (机械), elemental (元素), construct (构装体), fey (妖精), giant (巨人), goblinoid (哥布林)。
    *   `physical_resistance` / `magic_resistance`：物理和魔法抗性，用于减免相应类型的伤害。
        *   **计算公式**：`减伤倍率 = 1.0 - min(resistance, 0.9)`（最多减伤 90%）。
*   **情感系统属性**：详见“情感系统”章节。
*   **混乱值（Stagger）**：
    *   每个角色拥有 `stagger_value` (当前混乱值) 和 `max_stagger_value` (最大混乱值)。
    *   受到伤害时，混乱值会相应扣除。
    *   当混乱值归零时，角色进入**混乱状态 (Staggered)**：
        *   持续 **2 回合**。
        *   行动次数清零（无法行动）。
        *   受到的伤害提升至 **200%**。
        *   状态结束后，混乱值回满。

### 2.3. 状态效果详解

状态效果（Buffs/Debuffs）是战斗系统的关键变量，遵循以下核心规则：

*   **叠加规则**：
    *   **强度 (Intensity)**：取新旧效果中的最大值 (`max(old, new)`)。
    *   **层数/持续时间 (Duration)**：新旧效果层数相加 (`old + new`)。
    *   **特殊情况**：如果新增效果的 `duration` 为 0：
        *   若已有该效果，只更新强度，不增加层数。
        *   若无该效果，层数默认设为 1。

*   **特殊状态机制**：
    *   **加速 (Haste)**：
        *   获得时**立即**增加当前行动次数和每回合行动上限。
        *   强度固定为 1，持续期间保持 +1 行动次数。
        *   回合结束时层数 -1。
    *   **麻痹 (Paralysis)**：
        *   在伤害计算时，每个麻痹层数会使一个伤害骰子的结果归零。
        *   每归零一个骰子，消耗 1 层麻痹。
    *   **硬血 (Hardblood)**：
        *   一种特殊的资源型状态，强度代表数量，层数固定。
        *   可被特定技能消耗以造成额外伤害 (`HardbloodConsumeDamage`)。
    *   **黑夜领域 (Dark Domain)**：
        *   持续 3 回合。
        *   **回合结束效果**：获得 6级强壮(1回合)、6级易伤(1回合)、1级加速(下回合)、666点负面情感硬币。
        *   **特殊效果**：免疫一次致死伤害（触发后移除领域，HP变为1）。
    *   **削弱光环 (Weaken Aura)**：
        *   持续 5 回合。
        *   **回合结束效果**：对所有敌方施加 5级虚弱(1回合) 和 5级易伤(1回合)。

### 2.4. 角色管理命令

系统提供了一系列 Telegram 命令来管理角色：

| 命令 | 别名 | 功能描述 |
| :--- | :--- | :--- |
| `/create_character` | `/cc` | 创建一个新的友方角色。 |
| `/create_enemy` | `/ce` | 创建一个新的敌方角色。 |
| `/characters` | `/chars` | 显示所有友方角色列表。 |
| `/enemies` | | 显示所有敌方角色列表。 |
| `/show` | `/panel` | 显示指定角色的详细状态面板。 |
| `/race <角色名>` | | 管理角色的种族标签和抗性。 |
| `/health <角色名> <值>`| | 直接修改角色的当前生命值。 |
| `/reset <角色名>` | | 重置单个角色的状态，包括生命、行动次数和情感。 |
| `/reset_all` | | 重置所有角色的状态。 |
| `/create_core <角色名>`| | 创建一个核心角色（珏、露、莹、笙、曦）。 |
| `/switch <角色名> <人格>`| `/persona` | 切换核心角色的人格。 |
| `/personas <角色名>` | | 查看指定核心角色的可用人格列表。 |

---

## 3. 战斗与攻击逻辑

攻击逻辑是战斗系统的核心交互，通过对话式界面引导用户完成攻击、治疗和使用技能的完整流程。

### 3.1. 攻击流程

系统支持对友方 (`/attack`) 和敌方 (`/enemy`) 的攻击，流程相似但目标相反。

1.  **选择攻击者**：显示所有有剩余行动次数的角色供玩家选择。
2.  **选择技能**：列出攻击者所有可用的技能（未在冷却中且满足情感等级要求）。若无技能可用，则默认使用普通攻击。
3.  **选择目标**：根据技能类型（伤害、治疗、增益/减益）自动筛选并显示合法的目标列表。自我技能和范围（AOE）技能无需选择目标。
4.  **执行攻击**：计算所有效果，更新目标状态，并消耗攻击者的行动次数。
5.  **显示结果**：在聊天界面中显示详细的战斗结果，包括伤害、治疗量和状态变化。

### 3.2. 技能效果执行

*   **统一处理**：通过 `execute_skill_effect` 函数统一处理所有技能效果，并根据技能类型格式化输出结果。
*   **状态图标**：使用表情符号（如 ⚔️, 💚, ✨, 💀）直观地表示技能类型和角色状态。

### 3.3. 会话管理

系统使用 `ConversationHandler` 管理复杂的交互流程，确保攻击的每一步都有明确的状态和上下文，并支持随时使用 `/cancel` 命令中断操作。

---

## 4. 技能系统

技能系统负责定义和执行所有战斗动作的效果，包括伤害计算、状态应用和资源管理。

### 4.1. 技能类型

技能被分为不同类别，以决定其目标和效果：

| 类别 | 英文标识 | 描述 |
| :--- | :--- | :--- |
| 伤害技能 | `damage` | 对目标造成直接伤害。 |
| 治疗技能 | `healing` | 恢复目标的生命值。 |
| 增益技能 | `buff` | 为目标施加正面状态效果。 |
| 减益技能 | `debuff` | 为目标施加负面状态效果。 |
| 自我技能 | `self` | 仅对施法者自身生效。 |
| 范围技能 | `aoe_*` | 对多个目标（所有友方或所有敌方）同时生效。 |

### 4.2. 伤害计算

最终伤害是一个通过多阶段修正计算得出的复杂结果：

1.  **基础伤害**：通过解析骰子公式（如 `"2d6+5"`）计算得出。
2.  **伤害修正**：
    *   **攻防修正**：基于攻击者和防御者的攻击/防御属性差值进行调整。
    *   **种族特攻**：如果技能对目标的种族有特效，则应用伤害加成。
    *   **抗性减伤**：根据目标的抗性百分比减免伤害。
    *   **状态效果**：考虑攻击者的增伤效果（如“强壮”）和目标的减伤效果（如“守护”）。
    *   **混乱加成**：目标处于“混乱”状态时，受到的伤害会大幅增加。
3.  **最终伤害** = `基础伤害 × (各种修正)`

### 4.3. 状态效果

技能可以附带多种状态效果，通过 `effects` 字段定义，在技能执行时应用到目标身上，并有特定的持续时间。

### 4.4. 冷却系统

*   技能使用后会进入冷却倒计时。
*   冷却时间在每回合结束时减少，直到归零后技能才能再次使用。

---

## 5. 情感系统

情感系统是角色在**战斗会话（Battle Session）**中的短期成长机制，而非长期的RPG属性。角色通过在战斗中的特定行为获得情感硬币，提升情感等级，从而解锁更强大的技能。

### 5.1. 情感硬币与重置

*   **生命周期**：
    *   **战斗结束 (Battle End)**：情感等级和硬币**重置为 0**。
    *   **阶段结束 (Stage End)**：情感等级和硬币**保留**至下一阶段。
*   **获取方式**：
    *   **骰子结果**：投掷出最大值获得**正面硬币**，投掷出 1 则获得**负面硬币**。
    *   **战斗行为**：造成伤害、击杀目标或进行治疗等行为也会奖励情感硬币。
*   **升级机制**：
    *   当累积的硬币总数达到当前等级的升级要求时，角色将进入“待升级”状态。
    *   升级会在下个回合开始时自动处理。
    *   **升级类型**：根据正面和负面硬币的数量决定升级是“正面”还是“负面”。

### 5.2. 情感等级

*   **等级范围**：0 到 5 级。
*   **升级奖励**：
    *   **技能冷却缩减**：每次升级，角色的所有技能冷却时间都会减少 1 回合。
    *   **技能解锁**：许多高级技能需要达到特定的情感等级才能使用。

---

## 6. 回合系统

回合系统负责驱动战斗流程，管理所有角色的行动顺序、状态更新和资源恢复。为了支持连续战斗，系统区分了三种结束状态。

### 6.1. 战斗终止概念

1.  **回合结束 (Turn End)**：
    *   常规的战斗回合流转。
    *   恢复行动次数，冷却 -1，结算持续效果。
    *   **保留**：所有战斗状态、混乱值、情感等级。

2.  **阶段结束 (Stage End)**：
    *   连续战斗中波次之间的过渡。
    *   **清除**：状态效果 (Buff/Debuff)。
    *   **重置**：混乱值 (Stagger)。
    *   **保留**：HP、情感等级、情感硬币。

3.  **战斗结束 (Battle End)**：
    *   战斗会话的彻底结束。
    *   **清除**：状态效果。
    *   **重置**：混乱值、情感等级 (重置为0)。
    *   **保留**：HP。

### 6.2. 回合流程 (Turn End)

1.  **行动阶段**：玩家或 AI 控制角色执行行动（攻击、使用技能等），消耗行动次数。
2.  **回合结束 (`/end_turn`)**：当所有角色行动完毕后，由玩家手动触发回合结束。
3.  **效果处理**：
    *   **情感升级**：首先处理所有待升级角色的情感等级提升。
    *   **回合结束效果**：结算所有持续性伤害（如“中毒”、“烧伤”）和持续性治疗效果。
    *   **混乱值处理**：更新角色的混乱值状态。
4.  **资源恢复**：
    *   **行动次数**：恢复所有角色的行动次数至其最大值。
    *   **技能冷却**：所有处于冷却中的技能倒计时减 1。
5.  **新回合开始**：
    *   **回合开始效果**：触发“加速”等在回合开始时生效的状态。
    *   **情感效果**：应用由情感系统提供的被动增益。

---

## 7. 数据库系统

系统使用 SQLite 数据库来持久化所有游戏数据。核心数据表结构如下：

### 7.1. `characters`

存储所有角色的核心数据。

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER | 唯一标识符，主键。 |
| `name` | TEXT | 角色名称。 |
| `character_type` | TEXT | 角色类型（`friendly` 或 `enemy`）。 |
| `in_battle` | INTEGER | 是否在战斗中（0 或 1）。 |
| `health` / `max_health` | INTEGER | 当前/最大生命值。 |
| `attack` / `defense` | INTEGER | 攻击力/防御力。 |
| `current_persona` | TEXT | 核心角色当前的人格名称。 |
| ... | ... | 其他与情感、行动次数等相关的字段。 |

### 7.2. `skills`

存储所有可用技能的定义。

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER | 唯一标识符，主键。 |
| `name` | TEXT | 技能名称。 |
| `description` | TEXT | 技能效果的详细描述。 |
| `skill_category` | TEXT | 技能类型（`damage`, `healing` 等）。 |
| `damage_formula`| TEXT | 伤害/治疗量的骰子公式（如 `2d6+5`）。 |
| `cooldown` | INTEGER | 技能的冷却回合数。 |
| `effects` | TEXT | 附加状态效果的 JSON 定义。 |
|`required_emotion_level`|INTEGER | 使用此技能所需的情感等级。|

### 7.3. 关联表

*   **`character_skills`**: 将角色和技能关联起来，定义了每个角色当前拥有的技能。
*   **`character_status_effects`**: 存储角色当前承受的所有临时状态效果及其持续时间。
*   **情感相关表**: `emotion_coin_log`, `emotion_level_history`, `character_emotion_effects` 用于记录情感系统的详细历史和状态。

---

## 8. 主程序与效果集成

### 8.1. 主程序 (`main.py`)

这是机器人的主入口，负责：
*   **初始化**：加载配置，连接 Telegram API。
*   **数据库迁移**：在启动时自动运行 `run_migrations()`，确保数据库结构与代码同步。
*   **命令注册**：将所有模块（角色、技能、攻击等）的 Telegram 命令处理器注册到应用中。
*   **启动轮询**：启动机器人，开始监听和响应用户消息。

### 8.2. 特殊效果集成 (`special_effect_integration.py`)

该模块为复杂的、跨系统的特殊技能效果（如“硬血”、“黑夜领域”）提供了一个统一的管理和计算框架。

*   **`EffectIntegrationManager`**: 这是一个全局管理器，它注册了所有特殊效果，并提供统一的接口（如 `calculate_unified_damage`）供技能系统调用。这使得基础技能系统无需关心复杂效果的具体实现，实现了高度的解耦和可扩展性。